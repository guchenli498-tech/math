# Problem D 数据获取详细指南

## 一、NYC Open Data 数据获取（主要来源）

### 方法1：网页直接下载（最简单）

#### 1.1 311老鼠投诉数据

**步骤**：
1. 访问：https://data.cityofnewyork.us/Social-Services/311-Service-Requests-from-2010-to-Present/erm2-nwe9
2. 点击右上角 **"Export"** 或 **"Filter"** 按钮
3. 设置筛选条件：
   - `complaint_type` 包含 "Rodent" 或 "Mouse" 或 "Rat"
   - `borough` = "MANHATTAN"
   - 时间范围：最近2-3年（可选）
4. 点击 **"Export"** → 选择 **"CSV"** 格式
5. 下载文件，保存为 `311_rodent_manhattan.csv`

**需要的字段**：
- `unique_key` - 唯一标识
- `created_date` - 投诉日期
- `complaint_type` - 投诉类型
- `descriptor` - 描述
- `incident_address` - 地址
- `latitude`, `longitude` - 坐标
- `borough` - 行政区

**数据量**：可能很大（几万到几十万条），建议：
- 只下载最近2-3年的数据
- 或使用API限制数量

---

#### 1.2 人口普查数据

**步骤**：
1. 访问：https://data.cityofnewyork.us/City-Government/Census-Demographics-at-the-Neighborhood-Tabulation-Area/37yn-6x8y
2. 点击 **"Export"** → **"CSV"**
3. 下载文件，保存为 `census_nta.csv`

**注意**：这个数据是按NTA（Neighborhood Tabulation Area）划分的，需要映射到DSNY区域（MN01-MN12）

**需要的字段**：
- `nta_code`, `nta_name` - NTA代码和名称
- `total_population` - 总人口
- `median_household_income` - 收入中位数
- `poverty_rate` - 贫困率
- `total_housing_units` - 住房单元总数

---

#### 1.3 建筑数据

**步骤**：
1. 访问：https://data.cityofnewyork.us/Housing-Development/Building-Footprints/nqwf-w8eh
2. 点击 **"Filter"**：
   - `borough` = "MANHATTAN"
   - `residential_units` 在 1-9 之间
3. 点击 **"Export"** → **"CSV"**
4. 下载文件，保存为 `buildings_1to9_units.csv`

**需要的字段**：
- `bin` - 建筑标识号
- `borough` - 行政区
- `residential_units` - 住宅单元数
- `latitude`, `longitude` - 坐标

---

### 方法2：使用SODA API（适合编程）

**优点**：可以精确筛选，控制数据量

**步骤**：
1. 访问 https://data.cityofnewyork.us/profile/app_tokens
2. 注册账号（免费）
3. 创建 App Token（可选，但推荐，可以提高请求限制）
4. 使用Python脚本下载（见下方脚本）

---

## 二、其他数据源

### 2.1 街道网络数据（OpenStreetMap）

**使用Python库 osmnx**：

```python
import osmnx as ox

# 下载曼哈顿街道网络
G = ox.graph_from_place('Manhattan, New York, USA', network_type='drive')
ox.save_graphml(G, 'manhattan_streets.graphml')
```

**安装**：
```bash
pip install osmnx
```

---

### 2.2 DSNY垃圾收集数据

**如果无法直接获取，可以：**

1. **查找DSNY年度报告**
   - 搜索 "DSNY Annual Report" 或 "DSNY Waste Statistics"
   - 查找各区域的垃圾收集量数据

2. **估算方法**（基于问题描述）：
   - 全NYC: 24百万磅/天 = 12,000吨/天
   - 曼哈顿人口约占NYC的20-25%
   - 假设垃圾产生量与人口成正比
   - 曼哈顿: 约2,400-3,000吨/天
   - 12个区域平均: 200-250吨/天/区域

3. **使用人口数据估算**：
   - 假设每人每天产生约3-4磅垃圾
   - 各区域人口 × 3.5磅 = 每日垃圾产生量

---

### 2.3 当前收集频率数据

**如果无法获取精确数据，可以：**

1. **使用问题描述中的信息**：
   - 每个住宅建筑应该每周服务2-3次
   - 收集时间：7am-8am 或 6pm-7pm

2. **假设初始状态**：
   - 所有区域每周收集2次（作为基准）
   - 然后优化到2-3次

---

## 三、数据获取脚本

### 3.1 使用API下载311数据（推荐）

创建文件 `download_311_data.py`：

```python
import requests
import pandas as pd
from datetime import datetime, timedelta

# 你的App Token（可选，但推荐）
APP_TOKEN = "YOUR_APP_TOKEN_HERE"  # 从 https://data.cityofnewyork.us/profile/app_tokens 获取

# 数据集ID
DATASET_ID = "erm2-nwe9"
BASE_URL = f"https://data.cityofnewyork.us/resource/{DATASET_ID}.json"

# 构建查询
# 只获取最近2年的数据，减少数据量
two_years_ago = (datetime.now() - timedelta(days=730)).strftime("%Y-%m-%d")

params = {
    "$where": f"complaint_type LIKE '%Rodent%' AND borough='MANHATTAN' AND created_date >= '{two_years_ago}'",
    "$limit": 50000,  # 限制数量
    "$select": "unique_key,created_date,complaint_type,descriptor,incident_address,borough,latitude,longitude",
    "$order": "created_date DESC"
}

if APP_TOKEN:
    params["$$app_token"] = APP_TOKEN

print("正在下载311老鼠投诉数据...")
try:
    response = requests.get(BASE_URL, params=params, timeout=60)
    response.raise_for_status()
    
    data = response.json()
    df = pd.DataFrame(data)
    
    print(f"成功下载 {len(df)} 条记录")
    df.to_csv("311_rodent_manhattan.csv", index=False)
    print("已保存到 311_rodent_manhattan.csv")
    
except Exception as e:
    print(f"错误: {e}")
    print("\n提示：")
    print("1. 检查网络连接")
    print("2. 如果没有App Token，可以去掉APP_TOKEN参数（但可能有限制）")
    print("3. 或者直接从网页下载：https://data.cityofnewyork.us/Social-Services/311-Service-Requests-from-2010-to-Present/erm2-nwe9")
```

---

### 3.2 下载人口普查数据

创建文件 `download_census_data.py`：

```python
import requests
import pandas as pd

DATASET_ID = "37yn-6x8y"
BASE_URL = f"https://data.cityofnewyork.us/resource/{DATASET_ID}.json"

params = {
    "$limit": 200,  # NTA数量有限
    "$select": "nta_code,nta_name,total_population,median_household_income,poverty_rate,total_housing_units"
}

print("正在下载人口普查数据...")
try:
    response = requests.get(BASE_URL, params=params, timeout=30)
    response.raise_for_status()
    
    data = response.json()
    df = pd.DataFrame(data)
    
    print(f"成功下载 {len(df)} 条记录")
    df.to_csv("census_nta.csv", index=False)
    print("已保存到 census_nta.csv")
    
except Exception as e:
    print(f"错误: {e}")
    print("\n提示：直接从网页下载：https://data.cityofnewyork.us/City-Government/Census-Demographics-at-the-Neighborhood-Tabulation-Area/37yn-6x8y")
```

---

## 四、数据预处理脚本

### 4.1 将311投诉映射到DSNY区域

创建文件 `map_311_to_districts.py`：

```python
import pandas as pd
import geopandas as gpd
from shapely.geometry import Point

# 读取311数据
print("读取311数据...")
df_311 = pd.read_csv("311_rodent_manhattan.csv")
df_311 = df_311.dropna(subset=['latitude', 'longitude'])

# 创建地理点
geometry = [Point(xy) for xy in zip(df_311['longitude'], df_311['latitude'])]
gdf_311 = gpd.GeoDataFrame(df_311, geometry=geometry, crs='EPSG:4326')

# 读取DSNY区域数据（需要提取地理边界）
# 这里需要处理multipolygon列
print("读取DSNY区域数据...")
# 注意：需要从CSV中提取地理信息，可能需要使用geopandas

# 空间连接
# gdf_311_with_district = gpd.sjoin(gdf_311, gdf_districts, how='left', predicate='within')

print("映射完成")
```

---

## 五、快速开始方案（如果数据获取困难）

### 方案A：使用估算数据开始建模

如果无法快速获取所有数据，可以：

1. **使用问题描述中的信息估算**：
   - 曼哈顿12个区域，假设每个区域：
     - 人口：基于区域面积估算
     - 垃圾产生量：人口 × 3.5磅/天
     - 当前收集频率：假设每周2次
     - 老鼠投诉：基于垃圾暴露时间估算

2. **创建假设数据集**：
   - 使用合理的假设值
   - 在报告中明确说明假设
   - 后续可以替换为真实数据

### 方案B：最小数据集

至少需要：
1. ✅ DSNY区域地理数据（已有）
2. ⚠️ 各区域人口估算（基于面积或查找）
3. ⚠️ 老鼠投诉数据（311数据，相对容易获取）

---

## 六、数据获取优先级和时间分配

### 第1天（2-3小时）
- [ ] 下载311老鼠投诉数据（最重要，相对容易）
- [ ] 下载人口普查数据
- [ ] 分析现有DSNY区域数据

### 第2天（半天）
- [ ] 下载建筑数据
- [ ] 下载街道网络数据（osmnx）
- [ ] 数据清洗和预处理

### 第3天（如果需要）
- [ ] 查找DSNY报告数据
- [ ] 数据映射和聚合
- [ ] 创建区域特征矩阵

---

## 七、常见问题解决

### Q1: API请求被限制怎么办？
**A**: 
- 注册App Token可以提高限制
- 或者直接从网页下载CSV文件
- 或者分批下载（使用$offset参数）

### Q2: 数据太大下载不了？
**A**: 
- 添加时间筛选，只下载最近的数据
- 使用$limit限制数量
- 或者使用网页的筛选功能后下载

### Q3: 地理数据无法映射？
**A**: 
- 使用geopandas进行空间连接
- 或者使用邮政编码作为中间映射
- 或者手动创建映射表

### Q4: 某些数据找不到？
**A**: 
- 使用估算值（在报告中说明）
- 查找相关研究报告
- 使用问题描述中的信息

---

## 八、推荐的数据获取顺序

1. **立即（今天）**：
   - ✅ 分析现有DSNY数据
   - ⚠️ 下载311老鼠投诉数据（网页或API）

2. **明天**：
   - ⚠️ 下载人口普查数据
   - ⚠️ 下载建筑数据
   - ⚠️ 开始数据预处理

3. **并行进行**：
   - 建立模型框架
   - 设计评估指标
   - 开始写报告框架

---

## 九、数据质量检查

获取数据后，检查：
- [ ] 数据完整性（是否有缺失值）
- [ ] 数据范围（数值是否合理）
- [ ] 地理匹配（能否映射到MN01-MN12）
- [ ] 时间范围（数据是否最新）
- [ ] 单位统一（磅vs吨，英尺vs米）

---

**提示**：不要因为数据获取而耽误建模进度。可以先使用估算数据建立模型框架，然后逐步替换为真实数据。

